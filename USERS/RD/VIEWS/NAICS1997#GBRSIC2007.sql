CREATE OR REPLACE
VIEW NAICS1997#GBRSIC2007
AS
SELECT NAICS1997_ID,
GBRSIC2007_ID
FROM
(
    SELECT NAICS1997_ID,
    GBRSIC2007_ID,
    Hinted,
    RN,
    CASE
        WHEN MAX(HINTED) OVER (PARTITION BY NAICS1997_ID) = 1 THEN CASE
            WHEN Hinted = 0 AND RN = 1 THEN 0
            WHEN Hinted = 1 THEN 1
            ELSE RN
        END
        ELSE RN
    END AS RN_Calc
    FROM
    (
        SELECT A.NAICS1997_ID,
        E.GBRSIC2007_ID,
        CASE
            WHEN E.GBRSIC2007_ID = F.GBRSIC2007_ID THEN 1
            ELSE 0
        END AS Hinted,
        ROW_NUMBER() OVER (PARTITION BY A.NAICS1997_ID ORDER BY C.NAICS2007PARTIAL NULLS LAST, TO_NUMBER_SAFE(E.GBRSIC2007_ID) + 0 DESC) AS RN
        FROM NAICS1997#NAICS2002 A
        INNER JOIN NAICS2002#NAICS2007 B
            ON A.NAICS2002_ID = B.NAICS2002_ID
        INNER JOIN ISIC4#NAICS2007 C
            ON B.NAICS2007_ID = C.NAICS2007_ID
        INNER JOIN ISIC4#NACE2 D
            ON C.ISIC4_ID = D.ISIC4_ID
        INNER JOIN GBRSIC2007#NACE2 E
            ON D.NACE2_ID = E.NACE2_ID
        LEFT OUTER JOIN NAICS1997TOGBRSIC2007HINT F
            ON A.NAICS1997_ID = F.NAICS1997_ID
    )
)
WHERE RN_Calc = 1
WITH READ ONLY;

/*
SELECT A.NAICS1997_ID,
Z.Name AS NAICS1997_Name,
A.NAICS2002_ID,
A1.Name AS NAICS2002_Name,
B.NAICS2007_ID,
B1.Name AS NAICS2007_Name,
C.ISIC4_ID,
C1.Name AS ISIC4_Name,
C.ISIC4Partial,
C.NAICS2007Partial,
D.NACE2_ID,
D1.Name AS NACE2_Name,
E.GBRSIC2007_ID,
E1.Name AS GBRSIC2007_Name
, ROW_NUMBER() OVER (PARTITION BY A.NAICS1997_ID ORDER BY C.NAICS2007PARTIAL NULLS LAST, TO_NUMBER_SAFE(E.GBRSIC2007_ID) + 0 DESC) AS RN
FROM NAICS1997 Z
INNER JOIN NAICS1997#NAICS2002 A
    ON Z.ID = A.NAICS1997_ID
INNER JOIN NAICS2002 A1
    ON A.NAICS2002_ID = A1.ID
INNER JOIN NAICS2002#NAICS2007 B
    ON A.NAICS2002_ID = B.NAICS2002_ID
INNER JOIN NAICS2007 B1
    ON B.NAICS2007_ID = B1.ID
INNER JOIN ISIC4#NAICS2007 C
    ON B.NAICS2007_ID = C.NAICS2007_ID
INNER JOIN ISIC4 C1
    ON C.ISIC4_ID = C1.ID
INNER JOIN ISIC4#NACE2 D
    ON C.ISIC4_ID = D.ISIC4_ID
INNER JOIN NACE2 D1
    ON D.NACE2_ID = D1.ID
INNER JOIN GBRSIC2007#NACE2 E
    ON D.NACE2_ID = E.NACE2_ID
INNER JOIN GBRSIC2007 E1
    ON E.GBRSIC2007_ID = E1.ID
ORDER BY Z.ID;
*/